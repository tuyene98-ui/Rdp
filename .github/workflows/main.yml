name: Windows RDP Auto PC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Start
      run: echo "Starting job..."

    # ENABLE RDP
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Restart-Service termservice

    # CREATE RANDOM USER + PASS
    - name: Create RDP User
      run: |
        # Username random
        $user = "rdp" + -join ((48..57) + (97..122) | Get-Random -Count 4 | % {[char]$_})

        # Password random 16 k√Ω t·ª±
        $pass = -join ((33..126) | Get-Random -Count 16 | % {[char]$_})

        net user $user $pass /add
        net localgroup administrators $user /add

        echo "RDP_USER=$user" >> $env:GITHUB_ENV
        echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

    # INSTALL TAILSCALE
    - name: Install Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile ts.exe
        Start-Process ts.exe -ArgumentList "/quiet" -Wait

    # LOGIN TAILSCALE
    - name: Login Tailscale
      env:
        TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey $env:TS_KEY --hostname windows-rdp-${{ github.run_id }}

        Start-Sleep -Seconds 5
        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TS_IP=$ip" >> $env:GITHUB_ENV

    # SOFTWARE
    - name: Install Chocolatey
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

    - name: Install Software
      run: |
        choco install -y googlechrome
        choco install -y firefox
        choco install -y 7zip

    # WALLPAPER
    - name: Set Wallpaper
      run: |
        $path = "$env:TEMP\wall.jpg"
        Invoke-WebRequest -Uri "https://wallpaperaccess.com/full/317501.jpg" -OutFile $path
        reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d $path /f
        RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters

    # SHOW LOGIN + TAILSCALE
    - name: Login Info
      run: |
        Write-Host "====================================="
        Write-Host "           üîê RDP LOGIN INFO"
        Write-Host "====================================="
        Write-Host "Tailscale IP : $env:TS_IP"
        Write-Host "User         : $env:RDP_USER"
        Write-Host "Password     : $env:RDP_PASS"
        Write-Host "====================================="
        Write-Host "üëâ K·∫øt n·ªëi RDP b·∫±ng IP Tailscale nh√©!"
    
    - name: Done
      run: echo "RDP READY ‚úî"
