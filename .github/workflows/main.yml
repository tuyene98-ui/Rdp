name: Windows RDP Auto PC

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Set up job
      run: echo "Starting job..."

    # --- ENABLE RDP ---
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    # --- CREATE USER AUTO ---
    - name: Create RDP User
      run: |
        $user="vanlong"
        $pass=[System.Web.Security.Membership]::GeneratePassword(15,3)
        net user $user $pass /add
        net localgroup administrators $user /add

        echo "USERNAME=$user" >> $env:GITHUB_ENV
        echo "PASSWORD=$pass" >> $env:GITHUB_ENV

    # --- INSTALL SOFTWARE ---
    - name: Install Chocolatey
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

    - name: Install Common Software
      run: |
        choco install -y googlechrome
        choco install -y firefox
        choco install -y 7zip
        choco install -y vscode

    # --- SET WALLPAPER ---
    - name: Set Wallpaper
      run: |
        $path = "$env:TEMP\wallpaper.jpg"
        Invoke-WebRequest -Uri "https://wallpaperaccess.com/full/317501.jpg" -OutFile $path
        reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d $path /f
        RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters

    # --- SHOW LOGIN INFO ---
    - name: Display Login Info
      run: |
        Write-Host "===================================="
        Write-Host "        üîê RDP LOGIN INFO"
        Write-Host "===================================="
        Write-Host "Host      : $(hostname -I)"
        Write-Host "Username  : $env:USERNAME"
        Write-Host "Username  : $env:USERNAME"
        Write-Host "Username  : $env:USERNAME"
        Write-Host "User      : vanlong"
        Write-Host "Password  : $env:PASSWORD"
        Write-Host "===================================="

    - name: Complete job
      run: echo "RDP READY ‚úî"
